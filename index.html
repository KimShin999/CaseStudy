<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>gunny Fake</title>
    <link rel="stylesheet" href="gamegunnyFake.css">
</head>
<body>
<form action="index.html" method="get">
    <button class = "button button1">chơi lại</button>
</form>

<canvas id = "mygunny" style="border: 2px solid #d3d3d3" ></canvas>

    <script>
        let paincanvas = document.getElementById("mygunny");
        let ctx = paincanvas.getContext("2d");
        let currentPlayer = 0;
        let lucban;
        let giatrihuonggio ;


        let sound =function () {
            danban = new Audio("audio/danbann.wav");
            danban.play();
        }

        let nhacnens = function () {
            nhacnen = new Audio("audio/nhacnen.mp3")
            nhacnen.play();
        }

        let sukienbanphim = function (evt) {
            switch (evt.keyCode) {
                case 38:
                    if (currentPlayer ===0){
                            gocbans[currentPlayer].alpha += Math.PI/180;
                    } else
                    if (currentPlayer ===1){
                        gocbans[currentPlayer].alpha -= Math.PI/180;
                    }
                    break;
                case 40:
                    if (currentPlayer ===0){
                        gocbans[currentPlayer].alpha -= Math.PI/180;
                    } else
                    if (currentPlayer ===1){
                        gocbans[currentPlayer].alpha += Math.PI/180;
                    }
                    break
                case 32:
                    if (bullets[0].isFire) return;          // nếu thằng nhân vật 1 bắn thì thằng 2 k được bắn
                    if (bullets[1].isFire) return;          //
                    if (currentPlayer ===0){
                        luc = kimlucs.getx()                //lấy giá tọa độ x ngay tại lúc ấn dấu cách
                        lucban = (luc - 720)/10             //tính lấy lực bắn
                        sound();
                        bullets[currentPlayer] = new bullet(nhanvats[0].x,nhanvats[0].y,20,gocbans[currentPlayer].alpha)
                        bullets[currentPlayer].fire();
                        giatrihuonggio = Math.floor(Math.random()*6);
                        currentPlayer = 1;

                    } else
                    if (currentPlayer === 1){
                        luc = kimlucs.getx()
                        lucban = (luc - 720)/8
                        sound();
                        bullets[currentPlayer] = new bullet(nhanvats[1].x,nhanvats[1].y,20,gocbans[currentPlayer].alpha);
                        bullets[currentPlayer].fire();
                        giatrihuonggio = Math.floor(Math.random()*6);
                        currentPlayer = 0;
                    }

                case 107:                                   //hack máu
                    if (bullets[0].isFire) return;
                    if (bullets[1].isFire) return;
                    if (currentPlayer===0){
                        nhanvats[0].mau +=20;
                        currentPlayer = 1;
                    }else
                    if(currentPlayer===1){
                        nhanvats[1].mau +=20;
                        currentPlayer = 0;
                    }
            }

        }


        window.addEventListener("keydown",sukienbanphim)
        paincanvas.width = window.innerWidth;
        paincanvas.height = window.innerHeight;


        let nhanvat = function (x,y,tenhinhanh, cao,rong, mau) {   //nhân vật-----------------
            this.x = x;
            this.y = y;
            this.yy += 170
            this.cao = cao;
            this.rong = rong;
            this.mau = mau;
            this.image = new Image();
            this.image.src = tenhinhanh;


            this.creatnhanvat = function () {
                ctx.drawImage(this.image,this.x,this.y,this.cao,this.rong)
            }


            this.showmau = function () {                                       // vẽ thanh máu
                ctx.beginPath();
                ctx.fillStyle = "#FF0000"
                ctx.fillRect(this.x + 25, 620,this.mau, 10);
                ctx.stroke();
            }

            this.checkdie = function () {
                if(this.mau === 0){
                    this.image.src = "anh/die.png"
                    bullets[currentPlayer].image.src = " ";
                }
            }

        }

        nhanvats = [];
        nhanvats[0] = new nhanvat(280,650,"anh/Role1.png",150,150,100);
        nhanvats[1] = new nhanvat(1850,650,"anh/DungCuHocTap.png",150,150,100);

        nhanvats[0].creatnhanvat();
        nhanvats[1].creatnhanvat();


        let gocban = function(x,y,alpha){              //tạo góc bắn--------------------
            this.x = x+75;
            this.y = y+75;
            this.alpha = alpha

            this.xgoc =  this.x+Math.cos(this.alpha)*200;
            this.ygoc = this.y-Math.sin(this.alpha)*200;

            this.paingocban = function(){
                this.xgoc =  this.x+Math.cos(this.alpha)*200;
                this.ygoc = this.y-Math.sin(this.alpha)*200;
            ctx.moveTo(this.x,this.y);                               //vẽ đường căn góc
            ctx.lineTo(this.xgoc,this.ygoc);
            ctx.stroke();
            }
        }

        let gocbans = [];
        gocbans[0] = new gocban(nhanvats[0].x,nhanvats[0].y,Math.PI/4);
        gocbans[1] = new gocban(nhanvats[1].x,nhanvats[1].y,3*Math.PI/4);


        let thuocdo = function(x,y){                            //vẽ hình ảnh thước đo
            this.x = x;
            this.y = y;
            this.image = new Image();
            this.image.src = "anh/thuocdo.png"

            this.creatthuocdo = function () {
                ctx.beginPath();
                ctx.drawImage(this.image,this.x, this.y, 1000,150)
                ctx.closePath();
            }

        }
        let thuocdos = new thuocdo(650, 1000);


        let kimluc = function(x,y){
            this.x = x;
            this.y = y;
            this.dx = 5;

            this.kimluc = function () {                                       //vẽ lực chạy
                ctx.beginPath();
                ctx.fillStyle = "#FF0000"
                ctx.fillRect(this.x, this.y, 5 , 80);
                ctx.stroke();
            }

            this.positon = function () {
                this.x += this.dx
                if (this.x < 770 ){
                    this.dx = 5;
                }
                if (this.x > 1540 ){
                    this.dx = -5;
                }
            }

            this.getx =function () {                                //lấy giá trị lực chạy
                return this.x;
            }
        }
        let kimlucs = new kimluc(720,1050)


        let vegio = function(x,y){
            this.x = x;
            this.y = y;
            this.Vg = 0;
            this.giaitrihuonggio = giatrihuonggio;

            this.creatgio = function () {
                ctx.beginPath();
                ctx.fillStyle = "#FF0000"
                ctx.fillRect(this.x, this.y, 20 ,20);
                ctx.stroke();
            }

            this.huonggio = function () {
                console.log(this.giaitrihuonggio)
                switch (this.giaitrihuonggio) {
                    case 0:
                        return;
                    case 1:
                        ctx.beginPath();
                        ctx.arc(this.x - 30, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                    case 2:
                        ctx.beginPath();
                        ctx.arc(this.x - 30, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x - 60, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                    case 3:
                        ctx.beginPath();
                        ctx.arc(this.x - 30, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x - 60, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x - 90, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                    case 4:
                        ctx.beginPath();
                        ctx.arc(this.x + 50, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                    case 5:
                        ctx.beginPath();
                        ctx.arc(this.x + 50, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x + 80, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                    case 6:
                        ctx.beginPath();
                        ctx.arc(this.x + 50, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x + 80, 20, 10, 0, 2 * Math.PI)
                        ctx.arc(this.x + 110, 20, 10, 0, 2 * Math.PI)
                        ctx.fill();
                        ctx.stroke();
                        return;
                }
            }
        }
        let vegios = new vegio(paincanvas.width/2, 20)




        let bullet = function (x ,y, R, alpha) {         //Đạn----------------------
            this.x = x+75;
            this.y = y+75;
            this.xx = x + 75; //lưu vị trí đạn
            this.yy = y + 75; //lưu vị trí đạn
            this.R = R;
            this.alpha = alpha;
            this.velocity = lucban; //lực bắn
            this.Vx = 0;
            this.Vy = 0;
            this.isFire = false;

            this.image= new Image();
            this.image.src = "anh/BMR.png";

            this.creatBullet = function () {                        //vẽ đạn
                ctx.beginPath();
                ctx.drawImage(this.image,this.x-50,this.y,100,100)
                ctx.closePath();
            }


            this.fire = function () {
                let turnCheck = currentPlayer===0?1:0;
                if (bullets[turnCheck].isFire) return
                this.Vx = this.velocity * Math.cos(this.alpha);
                this.Vy = -this.velocity * Math.sin(this.alpha);
                this.isFire = true;
            }

            this.position = function () {                           //quỹ đạo chuyển động của đạn
                if (!this.isFire) return;
                this.x += this.Vx;
                this.y += this.Vy;
                this.Vy += 1
            }

            this.move = function () {
                this.position();
                this.creatBullet();
            }

            this.kiemtravacham = function(nhanvat) {
                let distant = (this.x - nhanvat.x-75)*(this.x - nhanvat.x-75) + (this.y - nhanvat.y-75)*(this.y - nhanvat.y-75);
                let R = 100*100
                if(distant < R ){

                    hinhanhvachams = new hinhanhvacham(this.x, this.y, 200);
                    hinhanhvachams.startTime = Date.now();
                    hinhanhvachams.isExist = true;

                    this.x = this.xx;
                    this.y = this.yy;
                    this.Vy = 0;

                    nhanvat.mau -= 40;                      //va chạm mất máu
                    if (nhanvat.mau < 0){
                        nhanvat.mau=0
                    }

                    this.isFire = false;
                }

                if (this.x < 0 || this.x > paincanvas.width || this.y > paincanvas.height ){
                    hinhanhvachams = new hinhanhvacham(this.x, this.y, 200);
                    hinhanhvachams.startTime = Date.now();
                    hinhanhvachams.isExist = true;

                    this.x = this.xx;
                    this.y = this.yy;
                    this.Vy = 0;
                    this.isFire = false;
                }
            }
        }

        let bullets = [];
        bullets[0] = new bullet(nhanvats[0].x,nhanvats[0].y,20,gocbans[0].alpha);
        bullets[1] = new bullet(nhanvats[1].x,nhanvats[1].y,20,gocbans[1].alpha);


        let hinhanhvacham = function(x,y,r){                        //hình ảnh va chạm của đạn
            this.x = x;
            this.y = y;
            this.R = r;
            this.isExist = false;
            this.startTime;
            this.endTime;
            this.image = new Image();
            this.image.src = "anh/haha.png"

            this.show = function () {
                if (!this.isExist) return;
                this.endTime = Date.now();
                if (this.endTime - this.startTime >500)
                    this.isExist = false;
                ctx.beginPath()
                ctx.drawImage(this.image,this.x-150,this.y-50,250,250)
                ctx.closePath()
            }
        }
         let hinhanhvachams = new hinhanhvacham(0,0,0)


        let chienthang = function (x,y) {                       //hiện biểu tượng chiến thắng
            this.x = x;
            this.y = y;
            this.image = new Image();
            this.image.src = "anh/chienthang.png"

            this.show = function (nhanvat) {
                if (nhanvat.mau === 0){
                    ctx.beginPath()
                    ctx.drawImage(this.image,this.x, this.y,800,700)
                    ctx.closePath()
                    alert("Ấn chơi lại để bắt đầu ván mới")
                }
            }
        }

        let chienthangs = [];
        chienthangs[0] = new chienthang(780,250);
        chienthangs[1] = new  chienthang(780,250)




        function update() {                                                 //hàm update
            ctx.clearRect(0, 0,window.innerWidth, window.innerHeight);
            nhacnens()
            thuocdos.creatthuocdo();
            kimlucs.kimluc();
            kimlucs.positon();
            vegios.creatgio();
            vegios.huonggio();
            nhanvats[0].creatnhanvat();
            nhanvats[1].creatnhanvat();
            nhanvats[0].showmau();
            nhanvats[1].showmau();
            gocbans[0].paingocban();
            gocbans[1].paingocban();
            bullets[0].move();
            bullets[1].move();
            bullets[0].kiemtravacham(nhanvats[1])
            bullets[1].kiemtravacham(nhanvats[0])
            nhanvats[0].checkdie();
            nhanvats[1].checkdie();
            chienthangs[0].show(nhanvats[1]);
            chienthangs[1].show(nhanvats[0])
            hinhanhvachams.show();
        }
        setInterval(update,35);

</script>
</body>
</html>